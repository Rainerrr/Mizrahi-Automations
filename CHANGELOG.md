# יומן שינויים - mizrahi_special_transactions.py

## גרסה 2.0.0 - 2026-01-04

### תיקונים

#### 1. תיקון טאב סיכום (שורות 6,7)
- **בעיה:** הטקסט הציג "בניהול מזרחי" במקום "בנאמנות מזרחי"
- **פתרון:** שונה הטקסט בשורות 6 ו-7 של טאב הסיכום:
  - `מספר קרנות של מנהל הקרן – בנאמנות מזרחי` (במקום "בניהול מזרחי")

#### 2. תיקון בדיקת תאריך חודשי
- **בעיה:** הסקריפט לא חיפש את התאריך החודשי הנכון
- **פתרון:** כעת הסקריפט מחשב אוטומטית את החודש הקודם (חודש נוכחי פחות 1) כברירת מחדל
- **שימוש:** ניתן לעקוף עם הפרמטר `--report-month YYYY-MM`

---

### תכונות חדשות

#### 3. בדיקה #4c - עקביות מחיר וסוג
- **תיאור:** בדיקה חדשה המוודאת שעסקאות עם אותו מספר נייר, תאריך ושעה יש להן מחיר וסוג זהים
- **לוגיקה:**
  - מקבץ עסקאות לפי (מספר נייר, תאריך, שעה)
  - בודק שכל העסקאות בקבוצה יש להן אותו מחיר
  - בודק שכל העסקאות בקבוצה יש להן אותו סוג
  - מקפיץ חריגה אם אחד התנאים לא מתקיים
- **פלט:** גיליון חדש "בדיקה #4c - מחיר/סוג" בקובץ האקסל
- **לוג:** קובץ לוג נפרד `chk4c_price_type_consistency.log`

#### 4. דגימה חכמה לחריגות מעל 100
- **תיאור:** כאשר יש יותר מ-100 חריגות, הסקריפט מבצע דגימה חכמה
- **לוגיקה:**
  - דגימה יחסית (stratified sampling) לפי סוג הסיבה
  - שומר על ייצוג מכל סוגי החריגות
  - מציג בסיכום "X (מתוך Y)" כאשר בוצעה דגימה
- **פרמטר חדש:** `--max-exceptions` (ברירת מחדל: 100)

---

### שיפורים

#### 5. שיפור בדיקה #5 - דגימת אופן החלטה
- **בעיה:** סוג החלטה 2 לא תמיד קפץ במדגם
- **פתרון:** הוספת לוגים מפורטים לפונקציית הדגימה:
  - מספר השורות התקינות הזמינות לדגימה
  - מספר השורות עם אופן החלטה 1
  - מספר השורות עם אופן החלטה 2
  - פרטי הדגימה שנבחרה
- **הערה:** הלוגיקה נכונה - הבעיה מתרחשת כאשר כל שורות dm2 סומנו כחריגות

#### 6. אימות בדיקה #7 - ניירות בעייתיים
- **סטטוס:** נבדק ואומת שהבדיקה עובדת כראוי
- **פונקציונליות:**
  - שליפת רשימות ניירות בעייתיים מאתר הבורסה (דלי סחירות, שימור, מושעים)
  - תמיכה בקאש לביצועים משופרים
  - לוגים מפורטים לכל התאמה

---

### פרמטרים חדשים בשורת הפקודה

| פרמטר | תיאור | ברירת מחדל |
|-------|-------|------------|
| `--max-exceptions` | סף מקסימלי לחריגות לפני דגימה חכמה | 100 |

---

### קבצי לוג חדשים

| קובץ | תיאור |
|------|-------|
| `chk4c_price_type_consistency.log` | בדיקת עקביות מחיר/סוג |

---

### שינויים בפלט האקסל

#### גיליונות חדשים
- **בדיקה #4c - מחיר/סוג** - חריגות של עסקאות עם מחיר/סוג לא עקביים

#### שינויים בטאב סיכום
- תוקן טקסט שורות 6,7
- נוסף שדה "סף דגימה חריגות"
- חריגות מוצגות בפורמט "X (מתוך Y)" כאשר בוצעה דגימה

#### שינויים בטאב סטטוס בדיקות
- נוספה שורה חדשה: "בדיקה #4c - חריגות מחיר/סוג"

---

### תאימות לאחור
- כל הפרמטרים הקיימים נשארים ללא שינוי
- ברירות המחדל החדשות לא משנות התנהגות קיימת (למעט חישוב חודש קודם)

---

### דוגמת שימוש

```bash
# הרצה בסיסית (יחשב אוטומטית את החודש הקודם)
python mizrahi_special_transactions.py \
    --mutual-funds-list "Mutual Funds List.xlsx" \
    --input-report "1702431.csv" \
    --output-xlsx "output.xlsx" \
    --email-json "email.json" \
    --manager-name "איילון"

# עם הגדרת חודש ספציפי וסף דגימה
python mizrahi_special_transactions.py \
    --mutual-funds-list "Mutual Funds List.xlsx" \
    --input-report "1702431.csv" \
    --output-xlsx "output.xlsx" \
    --email-json "email.json" \
    --manager-name "איילון" \
    --report-month "2025-12" \
    --max-exceptions 50
```
